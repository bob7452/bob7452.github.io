<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Tao&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Tao&#39;s Blog">
<meta property="og:url" content="https://bob7452.github.io/index.html">
<meta property="og:site_name" content="Tao&#39;s Blog">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Tao">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Tao's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tao&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://bob7452.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-[3]  Simple-Rootfs-Implement" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/03/%5B3%5D%20%20Simple-Rootfs-Implement/" class="article-date">
  <time class="dt-published" datetime="2025-08-03T10:07:00.000Z" itemprop="datePublished">2025-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/03/%5B3%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [3]</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1>üìò Chapter 3 - Advanced <code>sysfs</code> with <code>kobject</code>: Multiple Attributes and Nested Directories</h1>
<h2 id="üéØ-Goal">üéØ Goal</h2>
<p>Create a structured sysfs interface with multiple attributes and nested directories, allowing both reading and writing from userspace, and triggering simple actions on write.</p>
<hr>
<h2 id="üß±-Concepts-Covered">üß± Concepts Covered</h2>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kobject_create_and_add()</code></td>
<td>Create and add a kobject (directory) under <code>/sys</code></td>
</tr>
<tr>
<td><code>kobj_attribute</code></td>
<td>Represents a readable/writable sysfs file (attribute)</td>
</tr>
<tr>
<td><code>show</code> / <code>store</code></td>
<td>Callbacks for reading and writing attribute values</td>
</tr>
<tr>
<td>Nested kobjects</td>
<td>Organize attributes into hierarchical directories</td>
</tr>
<tr>
<td>Action triggers</td>
<td>Implement side effects inside <code>store()</code> callbacks</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="üìÇ-Filesystem-Layout">üìÇ Filesystem Layout</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/sys/kernel/hello_sysfs/</span><br><span class="line">‚îú‚îÄ‚îÄ value</span><br><span class="line">‚îú‚îÄ‚îÄ mode</span><br><span class="line">‚îú‚îÄ‚îÄ status</span><br><span class="line">‚îî‚îÄ‚îÄ config/</span><br><span class="line">    ‚îú‚îÄ‚îÄ enable</span><br><span class="line">    ‚îî‚îÄ‚îÄ debug_level</span><br></pre></td></tr></table></figure>
<p>Each file is a read/write interface accessible via <code>cat</code> and <code>echo</code>.</p>
<hr>
<h2 id="üß™-Complete-Code-Snippet">üß™ Complete Code Snippet</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kobject.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sysfs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Anonymous&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Advanced sysfs example with multiple attributes&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;0.2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">hello_kobj</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">config_kobj</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> value_str[<span class="number">128</span>] = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> mode_str[<span class="number">16</span>] = <span class="string">&quot;normal&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> status = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> debug_level = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> enabled = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">value_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s\n&quot;</span>, value_str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">value_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span> &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(value_str, <span class="keyword">sizeof</span>(value_str), <span class="string">&quot;%.*s&quot;</span>, (<span class="type">int</span>)(count - <span class="number">1</span>), buf);  <span class="comment">// trim newline</span></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_attribute</span> <span class="title">value_attr</span> =</span> __ATTR(value, <span class="number">0644</span>, value_show, value_store);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">mode_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s\n&quot;</span>, mode_str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">mode_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span> &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(mode_str, <span class="keyword">sizeof</span>(mode_str), <span class="string">&quot;%.*s&quot;</span>, (<span class="type">int</span>)(count - <span class="number">1</span>), buf);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_attribute</span> <span class="title">mode_attr</span> =</span> __ATTR(mode, <span class="number">0644</span>, mode_show, mode_store);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">status_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%d\n&quot;</span>, status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">status_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span> &#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%d&quot;</span>, &amp;status);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_attribute</span> <span class="title">status_attr</span> =</span> __ATTR(status, <span class="number">0644</span>, status_show, status_store);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">enable_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%d\n&quot;</span>, enabled);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">enable_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span> &#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%d&quot;</span>, &amp;enabled);</span><br><span class="line">    pr_info(<span class="string">&quot;sysfs: enable changed to %d\n&quot;</span>, enabled);  <span class="comment">// simulate action on write</span></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_attribute</span> <span class="title">enable_attr</span> =</span> __ATTR(enable, <span class="number">0644</span>, enable_show, enable_store);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">debug_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%d\n&quot;</span>, debug_level);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">debug_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span> &#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%d&quot;</span>, &amp;debug_level);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_attribute</span> <span class="title">debug_attr</span> =</span> __ATTR(debug_level, <span class="number">0644</span>, debug_show, debug_store);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    hello_kobj = kobject_create_and_add(<span class="string">&quot;hello_sysfs&quot;</span>, kernel_kobj);</span><br><span class="line">    <span class="keyword">if</span> (!hello_kobj)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    ret = sysfs_create_file(hello_kobj, &amp;value_attr.attr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to create value attribute\n&quot;</span>);</span><br><span class="line">        kobject_put(hello_kobj);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = sysfs_create_file(hello_kobj, &amp;mode_attr.attr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to create mode attribute\n&quot;</span>);</span><br><span class="line">        kobject_put(hello_kobj);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = sysfs_create_file(hello_kobj, &amp;status_attr.attr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to create status attribute\n&quot;</span>);</span><br><span class="line">        kobject_put(hello_kobj);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    config_kobj = kobject_create_and_add(<span class="string">&quot;config&quot;</span>, hello_kobj);</span><br><span class="line">    <span class="keyword">if</span> (!config_kobj) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to create config kobject\n&quot;</span>);</span><br><span class="line">        kobject_put(hello_kobj);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = sysfs_create_file(config_kobj, &amp;enable_attr.attr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to create enable attribute\n&quot;</span>);</span><br><span class="line">        kobject_put(config_kobj);</span><br><span class="line">        kobject_put(hello_kobj);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = sysfs_create_file(config_kobj, &amp;debug_attr.attr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;Failed to create debug_level attribute\n&quot;</span>);</span><br><span class="line">        kobject_put(config_kobj);</span><br><span class="line">        kobject_put(hello_kobj);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;sysfs: hello_sysfs initialized\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    sysfs_remove_file(hello_kobj, &amp;value_attr.attr);</span><br><span class="line">    sysfs_remove_file(hello_kobj, &amp;mode_attr.attr);</span><br><span class="line">    sysfs_remove_file(hello_kobj, &amp;status_attr.attr);</span><br><span class="line"></span><br><span class="line">    sysfs_remove_file(config_kobj, &amp;enable_attr.attr);</span><br><span class="line">    sysfs_remove_file(config_kobj, &amp;debug_attr.attr);</span><br><span class="line"></span><br><span class="line">    kobject_put(config_kobj);</span><br><span class="line">    kobject_put(hello_kobj);</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;sysfs: hello_sysfs removed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="üîß-Usage-Examples">üîß Usage Examples</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Read current value</span></span><br><span class="line"><span class="built_in">cat</span> /sys/kernel/hello_sysfs/value</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write new value</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Linux sysfs is cool&quot;</span> &gt; /sys/kernel/hello_sysfs/value</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read/write numeric status</span></span><br><span class="line"><span class="built_in">cat</span> /sys/kernel/hello_sysfs/status</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/kernel/hello_sysfs/status</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nested config directory files</span></span><br><span class="line"><span class="built_in">cat</span> /sys/kernel/hello_sysfs/config/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/hello_sysfs/config/enable</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="üîë-Key-Differences-Between-proc-and-sysfs-Here">üîë Key Differences Between <code>/proc</code> and <code>sysfs</code> Here</h2>
<table>
<thead>
<tr>
<th>Aspect</th>
<th><code>/proc</code></th>
<th><code>sysfs</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>Purpose</td>
<td>Mainly info &amp; debugging</td>
<td>Structured config &amp; control</td>
</tr>
<tr>
<td>Organization</td>
<td>Usually flat</td>
<td>Hierarchical (dirs + attributes)</td>
</tr>
<tr>
<td>Integration</td>
<td>Custom</td>
<td>Integrated with kernel object model</td>
</tr>
<tr>
<td>Tool support</td>
<td>Minimal</td>
<td>udev, systemd, hotplug support</td>
</tr>
<tr>
<td>Use cases</td>
<td>Debug logs, runtime info</td>
<td>Device config, status, triggers</td>
</tr>
</tbody>
</table>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/08/03/[3]%20%20Simple-Rootfs-Implement/" data-id="cmdvip5310001upj691r10pgd" data-title="Simple Rootfs [3]" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-[2]  Simple-Rootfs-Implement" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/03/%5B2%5D%20%20Simple-Rootfs-Implement/" class="article-date">
  <time class="dt-published" datetime="2025-08-03T09:45:00.000Z" itemprop="datePublished">2025-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/03/%5B2%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [2]</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1>üß† Linux Kernel Module: /proc/hello - Practice Notes</h1>
<h2 id="üìå-Overview">üìå Overview</h2>
<p>This example demonstrates how to write a simple Linux kernel module that creates a virtual file under <code>/proc/hello</code>:</p>
<ul>
<li>Reading <code>/proc/hello</code> shows a greeting message.</li>
<li>Writing to <code>/proc/hello</code> updates the message content.</li>
</ul>
<p>This is a great beginner-friendly exercise to understand how <code>/proc</code> and kernel modules interact.</p>
<hr>
<h2 id="üìÇ-Final-Source-Code">üìÇ Final Source Code</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Author&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;/proc/hello demo&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;0.1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROC_NAME <span class="string">&quot;hello&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BUF_LEN 128</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> hello_buf[MAX_BUF_LEN] = <span class="string">&quot;No message yet&quot;</span>;</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">### üîç Display <span class="title function_">Content</span> <span class="params">(Read Callback)</span></span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_show</span><span class="params">(<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v)</span> &#123;</span><br><span class="line">    seq_printf(m, <span class="string">&quot;üëã Hello %s!\n&quot;</span>, hello_buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Uses <code>seq_file</code> API to print the message.</li>
<li>Message comes from the buffer <code>hello_buf</code>, which can be updated by user writes.</li>
</ul>
<hr>
<h3 id="üîì-Open-Callback">üîì Open Callback</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> single_open(file, hello_show, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>single_open()</code> is used for simple read-only /proc files.</li>
</ul>
<hr>
<h3 id="‚úçÔ∏è-Write-Logic">‚úçÔ∏è Write Logic</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">hello_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buffer, <span class="type">size_t</span> count, <span class="type">loff_t</span> *ppos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="keyword">sizeof</span>(hello_buf) - <span class="number">1</span>)</span><br><span class="line">        count = <span class="keyword">sizeof</span>(hello_buf) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(hello_buf, buffer, count))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; hello_buf[count - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        hello_buf[count - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        hello_buf[count] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="üß©-Key-Points">üß© Key Points:</h4>
<ul>
<li><code>count</code> is passed by the kernel, indicating how many bytes the user wants to write.</li>
<li>To prevent buffer overflows, only <code>MAX_BUF_LEN - 1</code> bytes are copied.</li>
<li>If the last character is a newline (<code>\n</code>), it‚Äôs removed for cleaner output.</li>
<li>Uses <code>copy_from_user()</code> to safely copy data from userspace to kernel space.</li>
</ul>
<blockquote>
<p>‚úÖ Example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Kernel modules are fun!&quot;</span> &gt; /proc/hello</span><br><span class="line"><span class="built_in">cat</span> /proc/hello</span><br><span class="line">üëã Hello Kernel modules are fun!</span><br></pre></td></tr></table></figure>
</blockquote>
<hr>
<h3 id="üß∑-Registering-and-Removing-the-proc-file">üß∑ Registering and Removing the proc file</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">hello_fops</span> =</span> &#123;</span><br><span class="line">    .proc_open    = hello_open,</span><br><span class="line">    .proc_read    = seq_read,</span><br><span class="line">    .proc_write   = hello_write,</span><br><span class="line">    .proc_lseek   = seq_lseek,</span><br><span class="line">    .proc_release = single_release,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>proc_ops</code> (available in Linux 5.6+) defines the file operations.</li>
<li>Includes support for read, write, seek, and close.</li>
</ul>
<hr>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    proc_create(PROC_NAME, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;hello_fops);</span><br><span class="line">    pr_info(<span class="string">&quot;/proc/%s created\n&quot;</span>, PROC_NAME);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    remove_proc_entry(PROC_NAME, <span class="literal">NULL</span>);</span><br><span class="line">    pr_info(<span class="string">&quot;/proc/%s removed\n&quot;</span>, PROC_NAME);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>proc_create()</code> creates the <code>/proc/hello</code> file during module load.</li>
<li><code>remove_proc_entry()</code> removes the file during module unload.</li>
</ul>
<hr>
<h2 id="üß™-Test-Procedure">üß™ Test Procedure</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">insmod hello_proc.ko</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/hello</span><br><span class="line"><span class="comment"># üëã Hello No message yet!</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Linux rocks!&quot;</span> &gt; /proc/hello</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /proc/hello</span><br><span class="line"><span class="comment"># üëã Hello Linux rocks!</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>üß® Note: Without handling newlines, output may break into multiple lines. This is handled in the <code>write</code> logic.</p>
</blockquote>
<hr>
<h2 id="üìö-Bonus-What-is-zu">üìö Bonus: What is <code>%zu</code>?</h2>
<ul>
<li><code>size_t</code> is an unsigned integer type used for memory sizes and lengths.</li>
<li><code>%zu</code> is the correct format specifier for <code>size_t</code> in <code>printf()</code>-like functions.</li>
<li><code>%z</code> is a length modifier; <code>%zu</code> means ‚Äúunsigned size_t‚Äù.</li>
</ul>
<hr>
<h2 id="‚úÖ-What-You-Learned">‚úÖ What You Learned</h2>
<ul>
<li>How to create a virtual file under <code>/proc</code> using a kernel module.</li>
<li>How to use <code>seq_file</code> to implement a clean read interface.</li>
<li>How to use <code>copy_from_user()</code> to receive data from user space.</li>
<li>How to handle newline trimming and buffer safety.</li>
<li>How to set up and tear down a kernel module cleanly.</li>
</ul>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/08/03/[2]%20%20Simple-Rootfs-Implement/" data-id="cmdvhx8f4000188j6ewzq52zp" data-title="Simple Rootfs [2]" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-[1]  Simple-Rootfs-Implement" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/02/%5B1%5D%20%20Simple-Rootfs-Implement/" class="article-date">
  <time class="dt-published" datetime="2025-08-02T04:15:00.000Z" itemprop="datePublished">2025-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/02/%5B1%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [1]</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1>Kernel Module Makefile &amp; Find Usage Notes</h1>
<h2 id="üß©-Problem-Summary">üß© Problem Summary</h2>
<p>When using a Makefile to recursively build kernel modules in subdirectories, the following issue occurred:</p>
<ul>
<li>Using <code>make -C $$dir</code> did not produce <code>.ko</code> files.</li>
<li>The submodule <code>Makefile</code> used <code>M=$(PWD)</code> to pass the build path.</li>
<li><code>$(shell pwd)</code> was evaluated from the <strong>parent Makefile‚Äôs directory</strong>, not the actual submodule folder.</li>
</ul>
<p>As a result, the kernel build system couldn‚Äôt find the source files.</p>
<hr>
<h2 id="‚úÖ-Makefile-Fix-cd-Into-Each-Directory">‚úÖ Makefile Fix: <code>cd</code> Into Each Directory</h2>
<h3 id="Original-did-not-work">Original (did not work):</h3>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">rebuild_module:</span></span><br><span class="line">	@for dir in modules_src/*; do \</span><br><span class="line">		<span class="variable">$(MAKE)</span> -C $$dir; \</span><br><span class="line">	done</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line"><span class="comment">### Fixed version (working):</span></span><br><span class="line"></span><br><span class="line">```makefile</span><br><span class="line"><span class="section">rebuild_module:</span></span><br><span class="line">	@for dir in modules_src/*; do \</span><br><span class="line">		echo <span class="string">&quot;Building $$dir&quot;</span>; \</span><br><span class="line">		cd $$dir &amp;&amp; <span class="variable">$(MAKE)</span> clean &amp;&amp; <span class="variable">$(MAKE)</span>; \</span><br><span class="line">	done</span><br></pre></td></tr></table></figure>
<h3 id="Why-this-works">Why this works:</h3>
<ul>
<li><code>cd $$dir &amp;&amp; make</code> ensures the submodule <code>Makefile</code> evaluates <code>$(PWD)</code> correctly.</li>
<li>This is critical because the Linux kernel build system uses <code>M=$(PWD)</code> to locate the external module sources.</li>
</ul>
<hr>
<h2 id="üîç-Using-find-to-Copy-ko-Files-Exclude-Directories">üîç Using <code>find</code> to Copy <code>.ko</code> Files (Exclude Directories)</h2>
<p>To gather all <code>.ko</code> files <strong>except</strong> from ignored folders like <code>linux/</code>, <code>busybox/</code>, and <code>rootfs/</code>, and copy them into <code>rootfs/modules/</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . \( -path <span class="string">&quot;./linux&quot;</span> -o -path <span class="string">&quot;./busybox&quot;</span> -o -path <span class="string">&quot;./rootfs&quot;</span> \) -prune -o -<span class="built_in">type</span> f -name <span class="string">&quot;*.ko&quot;</span> -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; rootfs/modules/ \;</span><br></pre></td></tr></table></figure>
<h3 id="Explanation">Explanation:</h3>
<ul>
<li><code>-prune</code>: Skips the matched directory (prevents recursion into it).</li>
<li><code>-o</code>: Logical OR, used to combine <code>-prune</code> and the file search conditions.</li>
<li><code>-type f -name &quot;*.ko&quot;</code>: Searches for regular files with <code>.ko</code> extension.</li>
<li><code>-exec ... \;</code>: Executes the given command for each matched file.</li>
</ul>
<h3 id="üìå-What-is-in-find-exec">üìå What is <code>&#123;&#125;</code> in <code>find -exec</code>?</h3>
<ul>
<li><code>&#123;&#125;</code> is a <strong>placeholder</strong> in the <code>-exec</code> option.</li>
<li>It gets replaced by the <strong>current file path</strong> found by <code>find</code>.</li>
<li>Example:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.ko&quot;</span> -<span class="built_in">exec</span> <span class="built_in">cp</span> &#123;&#125; rootfs/modules/ \;</span><br></pre></td></tr></table></figure>
<p>If <code>find</code> discovers <code>./modules_src/hello_proc/hello_proc.ko</code>, the command executed will be:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> ./modules_src/hello_proc/hello_proc.ko rootfs/modules/</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>&#123;&#125;</code> will be substituted one at a time for each matched file.</p>
</blockquote>
<hr>
<h2 id="‚úÖ-Summary">‚úÖ Summary</h2>
<ul>
<li>Avoid <code>make -C</code> alone when your submodule <code>Makefile</code> depends on <code>$(PWD)</code> ‚Äî use <code>cd $$dir &amp;&amp; make</code> instead.</li>
<li>Use <code>find ... -prune</code> to selectively exclude directories when collecting files like <code>.ko</code>.</li>
<li>Use <code>&#123;&#125;</code> as a placeholder in <code>-exec</code> to refer to each found file‚Äôs full path.</li>
<li>Combine the above in a Makefile workflow to ensure proper module build and rootfs packaging.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/08/02/[1]%20%20Simple-Rootfs-Implement/" data-id="cmdvip52x0000upj6bmlhf28j" data-title="Simple Rootfs [1]" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-[0]  Simple-Rootfs-Implement" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/07/19/%5B0%5D%20%20Simple-Rootfs-Implement/" class="article-date">
  <time class="dt-published" datetime="2025-07-19T11:55:00.000Z" itemprop="datePublished">2025-07-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/07/19/%5B0%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [0]</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1>Minimal Linux RootFS on x86 with QEMU &amp; BusyBox</h1>
<p>ÈÄô‰ªΩË™™ÊòéÊï¥ÁêÜ‰∫ÜÂæû 0 Âª∫Á´ã‰∏ÄÂÄãÂèØÈñãÊ©üÁöÑ x86 Linux RootFS ÁöÑÈÅéÁ®ãÔºåÈÅ©ÂêàÁî®‰æÜÁ∑¥Áøí Linux Kernel Modules Ëàá RootFS ÁµêÊßã„ÄÇ</p>
<hr>
<h2 id="ÁõÆÊ®ô">ÁõÆÊ®ô</h2>
<ul>
<li>‰ΩøÁî® BusyBox Ë£Ω‰ΩúÊúÄÁ∞° RootFS</li>
<li>Âà©Áî® QEMU Âü∑Ë°å x86 kernel</li>
<li>ÁêÜËß£ init ÊµÅÁ®ãËàáÈåØË™§ÊéíÊü•</li>
<li>Áû≠Ëß£ÈùúÊÖãËàáÂãïÊÖãÈÄ£ÁµêÂ∑ÆÁï∞</li>
</ul>
<hr>
<h2 id="Ê™îÊ°àËàáÁõÆÈåÑÁµêÊßã">Ê™îÊ°àËàáÁõÆÈåÑÁµêÊßã</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kernel-rootfs/</span><br><span class="line">‚îú‚îÄ‚îÄ linux</span><br><span class="line">    ‚îî‚îÄ‚îÄ  arch</span><br><span class="line">      ‚îî‚îÄ‚îÄ x86</span><br><span class="line">        ‚îî‚îÄ‚îÄ boot</span><br><span class="line">          ‚îî‚îÄ‚îÄ bzImage              # Â∑≤Á∑®Ë≠ØÁöÑ Linux Kernel (x86)</span><br><span class="line">‚îú‚îÄ‚îÄ rootfs.cpio                    # Â∞ÅË£ùÁöÑ rootfs</span><br><span class="line">‚îî‚îÄ‚îÄ rootfs/                        # ÂØ¶ÈöõÁöÑ rootfs ÁµêÊßã</span><br><span class="line">‚îú‚îÄ‚îÄ init                           # ÈñãÊ©ü init ËÖ≥Êú¨</span><br><span class="line">‚îú‚îÄ‚îÄ bin/</span><br><span class="line">‚îÇ   ‚îú‚îÄ‚îÄ busybox</span><br><span class="line">‚îÇ   ‚îî‚îÄ‚îÄ sh -&gt; busybox</span><br><span class="line">‚îú‚îÄ‚îÄ proc/</span><br><span class="line">‚îî‚îÄ‚îÄ sys/</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Ê≠•È©üË™™Êòé">Ê≠•È©üË™™Êòé</h2>
<h3 id="0-ÂâµÂª∫‰∏ÄÂÄã-rootfsÁöÑÁõÆÈåÑ">0. ÂâµÂª∫‰∏ÄÂÄã rootfsÁöÑÁõÆÈåÑ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/rootfs</span><br><span class="line"><span class="built_in">cd</span> ~/rootfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Âª∫Á´ãÂü∫Êú¨ÁµêÊßã</span></span><br><span class="line"><span class="built_in">mkdir</span> -p bin sbin etc proc sys usr/bin usr/sbin dev tmp</span><br></pre></td></tr></table></figure>
<h3 id="1-ÂèñÂæó-Linux-kernel">1. ÂèñÂæó Linux kernel</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/torvalds/linux.git</span><br><span class="line"><span class="built_in">cd</span> linux</span><br><span class="line">make defconfig</span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure>
<h3 id="2-‰∏ãËºâ‰∏¶Á∑®Ë≠Ø-BusyBoxÔºàÈùúÊÖãÈÄ£ÁµêÔºâ">2. ‰∏ãËºâ‰∏¶Á∑®Ë≠Ø BusyBoxÔºàÈùúÊÖãÈÄ£ÁµêÔºâ</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/mirror/busybox.git</span><br><span class="line"><span class="built_in">cd</span> busybox</span><br><span class="line">make distclean</span><br><span class="line">make defconfig</span><br></pre></td></tr></table></figure>
<hr>
<p>Á∑®ËºØ <code>.config</code> ÂïüÁî®ÈùúÊÖãÈÄ£ÁµêÔºö</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">-&gt; Settings -&gt; Build static binary (no shared libs) [*]</span><br></pre></td></tr></table></figure>
<p>ÁÑ∂ÂæåÂÆâË£ùÂà∞ rootfsÔºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j$(nproc)</span><br><span class="line">make CONFIG_PREFIX=../rootfs install</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="3-Êí∞ÂØ´-init-ËÖ≥Êú¨">3. Êí∞ÂØ´ init ËÖ≥Êú¨</h3>
<p><code>rootfs/init</code>Ôºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">echo &quot;Welcome to minimal rootfs!&quot;</span><br><span class="line">exec /bin/sh</span><br></pre></td></tr></table></figure>
<p>Êé•ËëóÊõ¥ÊîπÁÇ∫ÂèØÂü∑Ë°å</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x rootfs/init</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="4-ÊâìÂåÖ-initramfs">4. ÊâìÂåÖ initramfs</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd rootfs</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="5-‰ΩøÁî®-QEMU-ÈñãÊ©ü">5. ‰ΩøÁî® QEMU ÈñãÊ©ü</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -kernel linux/arch/x86/boot/bzImage \</span><br><span class="line">  -initrd rootfs.cpio \</span><br><span class="line">  -nographic \</span><br><span class="line">  -append <span class="string">&quot;console=ttyS0 init=/init&quot;</span></span><br></pre></td></tr></table></figure>
<p>Â¶ÇÊûúÊ≠£Â∏∏ÈÅã‰ΩúÔºå‰Ω†ÊúÉÁúãÂà∞ BusyBox ÁöÑ shellÔºö</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ # </span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Â∏∏Ë¶ãÈåØË™§ÊéíÊü•">Â∏∏Ë¶ãÈåØË™§ÊéíÊü•</h2>
<h3 id="Kernel-panic-error-2-ENOENT">Kernel panic - error -2 (ENOENT)</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Failed to execute /init (error -2)</span><br><span class="line">Kernel panic - not syncing: Requested init /init failed</span><br></pre></td></tr></table></figure>
<p>Ëß£Ê≥ïÔºö</p>
<ul>
<li><code>/init</code> ÊòØËÖ≥Êú¨ÔºåË¶ÅÊúâÊ≠£Á¢∫ÁöÑ shebangÔºö<code>#!/bin/sh</code></li>
<li><strong>BusyBox ÂøÖÈ†à‰ΩøÁî®ÈùúÊÖãÈÄ£Áµê</strong>ÔºåÂê¶ÂâáÊúÉÊâæ‰∏çÂà∞ÂãïÊÖã linker <code>/lib/ld-linux.so.2</code></li>
<li>Áî® <code>file rootfs/bin/busybox</code> Á¢∫Ë™çÔºö</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ELF 64-bit ... statically linked ...</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ÈùúÊÖãÈÄ£Áµê-vs-ÂãïÊÖãÈÄ£Áµê">ÈùúÊÖãÈÄ£Áµê vs ÂãïÊÖãÈÄ£Áµê</h2>
<table>
<thead>
<tr>
<th>È°ûÂûã</th>
<th>Ë™™Êòé</th>
</tr>
</thead>
<tbody>
<tr>
<td>ÈùúÊÖãÈÄ£Áµê</td>
<td>ÊâÄÊúâÈúÄË¶ÅÁöÑÂáΩÂºèÂ∫´ÈÉΩÁ∑®Ë≠ØÈÄ≤ÂèØÂü∑Ë°åÊ™îÔºåÁÑ°ÈúÄÈ°çÂ§ñ <code>.so</code> Ê™îÊ°à</td>
</tr>
<tr>
<td>ÂãïÊÖãÈÄ£Áµê</td>
<td>Âü∑Ë°åÊôÇËºâÂÖ•ÂÖ±‰∫´ÂáΩÂºèÂ∫´ÔºåÂ¶Ç <code>/lib64/ld-linux-x86-64.so.2</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Âú® initramfs ÊàñÊúÄÂ∞è rootfs ‰∏≠ÔºåÊáâË©≤‰ΩøÁî® <strong>ÈùúÊÖãÈÄ£Áµê</strong> binary„ÄÇ</p>
</blockquote>
<hr>
<h2 id="È©óË≠â-checklist">È©óË≠â checklist</h2>
<table>
<thead>
<tr>
<th>Ê™¢Êü•È†Ö</th>
<th>ÂëΩ‰ª§</th>
<th>È†êÊúüÁµêÊûú</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/bin/sh</code> ÊòØÂê¶Â≠òÂú®</td>
<td><code>ls -l rootfs/bin/sh</code></td>
<td>ÊáâË©≤ÁÇ∫ <code>sh -&gt; busybox</code> ÁöÑÁ¨¶ËôüÈÄ£Áµê</td>
</tr>
<tr>
<td>busybox ÈÄ£ÁµêÊñπÂºè</td>
<td><code>file rootfs/bin/busybox</code></td>
<td>ÊáâÁÇ∫ <code>statically linked</code></td>
</tr>
<tr>
<td>init ÊòØÂê¶ÂèØÂü∑Ë°å</td>
<td><code>chmod +x rootfs/init</code></td>
<td>Âê¶ÂâáÊúÉÂá∫ÁèæÊ¨äÈôêÈåØË™§</td>
</tr>
<tr>
<td>ÊòØÂê¶ÊúâÊéõËºâ proc/sys</td>
<td><code>mount -t proc none /proc</code> Á≠â</td>
<td>Âê¶ÂâáÂæàÂ§öÂ∑•ÂÖ∑ÊúÉÈåØË™§ÊàñÁÑ°Ê≥ïÂü∑Ë°å</td>
</tr>
</tbody>
</table>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/07/19/[0]%20%20Simple-Rootfs-Implement/" data-id="cmdtqqujq00007wj6dobja7k6" data-title="Simple Rootfs [0]" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Understanding-in-the-Linux-Kernel" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/22/Understanding-in-the-Linux-Kernel/" class="article-date">
  <time class="dt-published" datetime="2025-03-22T12:52:43.000Z" itemprop="datePublished">2025-03-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/22/Understanding-in-the-Linux-Kernel/">Understanding  in the Linux Kernel</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1>Understanding <code>Kconfig</code> in the Linux Kernel</h1>
<p><code>Kconfig</code> is a configuration system used in the Linux kernel and many large C/C++ projects to manage <strong>build-time options</strong>. It defines user-selectable features, modules, and dependencies.</p>
<hr>
<h2 id="üîß-Purpose-of-Kconfig">üîß Purpose of <code>Kconfig</code></h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Define configuration options</td>
<td>Allows defining features that users can enable or disable (e.g., enable a specific driver)</td>
</tr>
<tr>
<td>Control dependencies</td>
<td>Ensures options are only available when their prerequisites are met (<code>depends on</code>)</td>
</tr>
<tr>
<td>Provide menu structure</td>
<td>Enables interactive selection through tools like <code>make menuconfig</code></td>
</tr>
<tr>
<td>Support tristate logic</td>
<td>Allows options to be built-in (<code>Y</code>), disabled (<code>N</code>), or built as a module (<code>M</code>)</td>
</tr>
<tr>
<td>Generate config headers</td>
<td>Produces files like <code>autoconf.h</code> from <code>.config</code> to control the final compilation behavior</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="üõ†-How-It-Works-Together">üõ† How It Works Together</h2>
<ol>
<li><strong>Kconfig files</strong> define all possible configuration items.</li>
<li><strong><code>make menuconfig</code> / <code>xconfig</code></strong> provides an interactive UI for configuration.</li>
<li><strong><code>.config</code></strong> stores the selected configuration options.</li>
<li><strong>Makefile + build system</strong> uses <code>.config</code> to compile selected modules and features.</li>
</ol>
<hr>
<h2 id="üîÅ-Flow-From-Kconfig-to-Makefile">üîÅ Flow: From <code>Kconfig</code> to <code>Makefile</code></h2>
<ol>
<li>
<p><strong>You run a config tool</strong>, like:</p>
<ul>
<li><code>make menuconfig</code></li>
<li><code>make defconfig</code></li>
<li><code>make oldconfig</code></li>
</ul>
</li>
<li>
<p><strong>These tools read the <code>Kconfig</code> files</strong>, which define options like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config NVME_CORE</span><br><span class="line">    bool &quot;NVMe core support&quot;</span><br><span class="line">    default y</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Your selections are saved to <code>.config</code></strong> in the kernel source root.</p>
</li>
<li>
<p><strong>The build system parses <code>.config</code> and sets environment macros</strong> like:</p>
<figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NVME_CORE=y</span><br><span class="line">CONFIG_NVME_TCP=m</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>The kernel Makefiles (<code>Kbuild</code>) use these <code>CONFIG_*</code> variables</strong> to control compilation:</p>
<figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_NVME_CORE)</span> += nvme-core.o</span><br><span class="line">nvme-core-y += core.o ioctl.o sysfs.o</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="üß†-What-Does-obj-CONFIG-Do">üß† What Does <code>obj-$(CONFIG_*)</code> Do?</h2>
<table>
<thead>
<tr>
<th>Value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CONFIG_FOO=y</code></td>
<td>Compiles the object into the kernel binary</td>
</tr>
<tr>
<td><code>CONFIG_FOO=m</code></td>
<td>Compiles the object as a loadable module (<code>.ko</code>)</td>
</tr>
<tr>
<td><code>CONFIG_FOO=n</code></td>
<td>Skips building this feature</td>
</tr>
</tbody>
</table>
<h3 id="Example">Example:</h3>
<figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_NVME_TCP)</span> += nvme-tcp.o</span><br><span class="line">nvme-tcp-y += tcp.o</span><br></pre></td></tr></table></figure>
<p>If <code>CONFIG_NVME_TCP=m</code>, this compiles <code>tcp.o</code> into <code>nvme-tcp.ko</code>.</p>
<hr>
<h2 id="üìÅ-Where-Are-These-Kconfig-Files">üìÅ Where Are These <code>Kconfig</code> Files?</h2>
<p>In the NVMe subsystem, the options are defined in files like:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drivers/nvme/host/Kconfig</span><br></pre></td></tr></table></figure>
<p>Example entry:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config NVME_TCP</span><br><span class="line">    tristate &quot;NVMe over TCP support&quot;</span><br><span class="line">    depends on NET</span><br><span class="line">    select NVME_FABRICS</span><br></pre></td></tr></table></figure>
<p>This defines <code>CONFIG_NVME_TCP</code>, which is used by the Makefile.</p>
<hr>
<h2 id="üìÑ-Real-world-Example-from-Makefile">üìÑ Real-world Example from <code>Makefile</code></h2>
<figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ccflags-y                             += -I<span class="variable">$(src)</span></span><br><span class="line"></span><br><span class="line">obj-<span class="variable">$(CONFIG_NVME_CORE)</span>              += nvme-core.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_BLK_DEV_NVME)</span>           += nvme.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_NVME_FABRICS)</span>           += nvme-fabrics.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_NVME_RDMA)</span>              += nvme-rdma.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_NVME_FC)</span>                += nvme-fc.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_NVME_TCP)</span>               += nvme-tcp.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_NVME_APPLE)</span>             += nvme-apple.o</span><br><span class="line"></span><br><span class="line">nvme-core-y                          += core.o ioctl.o sysfs.o pr.o</span><br><span class="line">nvme-core-<span class="variable">$(CONFIG_NVME_VERBOSE_ERRORS)</span> += constants.o</span><br><span class="line">nvme-core-<span class="variable">$(CONFIG_TRACING)</span>          += trace.o</span><br><span class="line">nvme-core-<span class="variable">$(CONFIG_NVME_MULTIPATH)</span>   += multipath.o</span><br><span class="line">nvme-core-<span class="variable">$(CONFIG_BLK_DEV_ZONED)</span>    += zns.o</span><br><span class="line">nvme-core-<span class="variable">$(CONFIG_FAULT_INJECTION_DEBUG_FS)</span> += fault_inject.o</span><br><span class="line">nvme-core-<span class="variable">$(CONFIG_NVME_HWMON)</span>       += hwmon.o</span><br><span class="line">nvme-core-<span class="variable">$(CONFIG_NVME_HOST_AUTH)</span>   += auth.o</span><br><span class="line"></span><br><span class="line">nvme-y                               += pci.o</span><br><span class="line">nvme-fabrics-y                       += fabrics.o</span><br><span class="line">nvme-rdma-y                          += rdma.o</span><br><span class="line">nvme-fc-y                            += fc.o</span><br><span class="line">nvme-tcp-y                           += tcp.o</span><br><span class="line">nvme-apple-y                         += apple.o</span><br></pre></td></tr></table></figure>
<p>These rules dynamically include files based on <code>Kconfig</code> options set by the user.</p>
<h2 id="‚úÖ-Summary">‚úÖ Summary</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Kconfig</code></td>
<td>Defines user-configurable options (<code>CONFIG_*</code>)</td>
</tr>
<tr>
<td><code>.config</code></td>
<td>Saves selected options from menuconfig or defconfig</td>
</tr>
<tr>
<td><code>Makefile</code>/Kbuild</td>
<td>Uses <code>obj-$(CONFIG_*)</code> to conditionally include source files</td>
</tr>
</tbody>
</table>
<p>The <code>CONFIG_*</code> flags seen in the Makefile are <strong>not manually defined</strong>, but are instead automatically generated based on the user‚Äôs configuration selected via <code>Kconfig</code>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/03/22/Understanding-in-the-Linux-Kernel/" data-id="cmdbbev1j0004o3j642is3m97" data-title="Understanding  in the Linux Kernel" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Understanding-Series/" rel="tag">Linux - Understanding Series</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Understanding-and-A-Comparison-of-Linux-Kernel-Cleanup-Commands" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/22/Understanding-and-A-Comparison-of-Linux-Kernel-Cleanup-Commands/" class="article-date">
  <time class="dt-published" datetime="2025-03-22T11:51:18.000Z" itemprop="datePublished">2025-03-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/22/Understanding-and-A-Comparison-of-Linux-Kernel-Cleanup-Commands/">Understanding A Comparison of Linux Kernel Cleanup Commands</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>make clean</code></strong></td>
<td>Deletes most generated files, such as object files (<code>*.o</code>) and kernel object files (<code>*.ko</code>), but retains the kernel configuration file (<code>.config</code>) and enough build support to build external modules.</td>
</tr>
<tr>
<td><strong><code>make mrproper</code></strong></td>
<td>Performs all actions of <code>make clean</code> and additionally removes the current configuration (<code>.config</code>) and all other generated files, returning the source tree to a pristine state.</td>
</tr>
<tr>
<td><strong><code>make distclean</code></strong></td>
<td>Executes all actions of <code>make mrproper</code> and further removes editor backup files, patch leftover files, and similar artifacts, effectively restoring the source tree to its original state as distributed.</td>
</tr>
</tbody>
</table>
<blockquote>
<p>üßπ <strong>Cleanup Scope Summary:</strong></p>
<p>The order of increasing cleanup scope is:</p>
<p><code>make clean</code> &lt; <code>make mrproper</code> &lt; <code>make distclean</code></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/03/22/Understanding-and-A-Comparison-of-Linux-Kernel-Cleanup-Commands/" data-id="cmdbbev1i0003o3j62ufx2dwb" data-title="Understanding A Comparison of Linux Kernel Cleanup Commands" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Understanding-Series/" rel="tag">Linux - Understanding Series</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux-NVMe-Driver" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/15/Linux-NVMe-Driver/" class="article-date">
  <time class="dt-published" datetime="2025-03-15T15:15:03.000Z" itemprop="datePublished">2025-03-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/15/Linux-NVMe-Driver/">Linux NVMe Driver</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1>Install a Specific Version of the Ubuntu Linux Kernel</h1>
<p>This guide explains how to clone the Linux kernel source code corresponding to the current kernel version and install the necessary kernel headers.</p>
<h2 id="Step-1-Clone-the-Linux-Kernel-Repository">Step 1: Clone the Linux Kernel Repository</h2>
<p>Use the following command to clone the stable version of the Linux kernel that matches your current kernel version:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt <span class="built_in">source</span> linux-modules-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>
<h3 id="Error-1-1-You-must-put-some-‚Äòdeb-src‚Äô-URIs-in-your-sources-list">Error 1-1: You must put some ‚Äòdeb-src‚Äô URIs in your sources.list</h3>
<p>If you encounter a <code>deb-src</code> related error, follow these steps:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
<p>Add the following lines to <code>sources.list</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb-src http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line">deb-src http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong> Replace <code>noble</code> or <code>jammy</code> with your Ubuntu version codename:</p>
<ul>
<li>Ubuntu 24.04: <code>noble</code></li>
<li>Ubuntu 22.04: <code>jammy</code></li>
</ul>
<p>Check your Ubuntu version:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -c</span><br></pre></td></tr></table></figure>
<p>Update the package list:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br></pre></td></tr></table></figure>
<h2 id="Step-2-Install-Linux-Kernel-Headers">Step 2: Install Linux Kernel Headers</h2>
<p>Kernel headers are required for compiling drivers or building kernel modules.</p>
<h3 id="Install-Kernel-Headers-on-Debian-Ubuntu">Install Kernel Headers on Debian/Ubuntu:</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install linux-headers-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>
<h3 id="Install-Kernel-Headers-on-RHEL-CentOS">Install Kernel Headers on RHEL/CentOS:</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install kernel-devel-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>
<h3 id="Install-Kernel-Headers-on-Arch-Linux">Install Kernel Headers on Arch Linux:</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> pacman -S linux-headers</span><br></pre></td></tr></table></figure>
<h2 id="Step-3-Verify-Installation">Step 3: Verify Installation</h2>
<p>To verify that the kernel headers have been installed successfully, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /usr/src/linux-headers-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>
<p>If the directory exists, the installation was successful.</p>
<h2 id="Step-4-Install-Required-Dependencies">Step 4: Install Required Dependencies</h2>
<p>Before configuring and compiling the kernel, install the required dependencies:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install build-essential libncurses-dev flex bison libssl-dev libelf-dev bc dwarves</span><br></pre></td></tr></table></figure>
<p>These packages include essential build tools, libraries for kernel configuration, and utilities for compiling the Linux kernel.</p>
<h2 id="Step-5-Configure-the-Kernel">Step 5: Configure the Kernel</h2>
<p>Generate a default configuration for your system:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/source/linux</span><br><span class="line"><span class="built_in">cp</span> /boot/config-$(<span class="built_in">uname</span> -r) .config</span><br><span class="line">make olddefconfig</span><br></pre></td></tr></table></figure>
<p>If required, manually add missing options.</p>
<h2 id="Step-6-Rebuild-Kernel">Step 6: Rebuild Kernel</h2>
<p>Before building the kernel modules, prepare the kernel using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure>
<p>This step ensures that the necessary headers and scripts are set up for building external modules.</p>
<h2 id="Step-7-Rebuild-Kernel-Module">Step 7: Rebuild Kernel Module</h2>
<p>Compile the NVMe kernel module:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C /lib/modules/$(<span class="built_in">uname</span> -r)/build M=<span class="variable">$PWD</span>/drivers/nvme/host modules</span><br></pre></td></tr></table></figure>
<h2 id="Conclusion">Conclusion</h2>
<p>This guide covers cloning the Linux kernel source code, installing the appropriate kernel headers, installing necessary dependencies, configuring the kernel, and preparing kernel modules for compilation. These steps are essential for kernel development, driver development, or custom kernel compilation.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/03/15/Linux-NVMe-Driver/" data-id="cmdbbev1e0000o3j65ikjd56u" data-title="Linux NVMe Driver" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Driver/" rel="tag">Linux - Driver</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/15/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-03-15T14:23:48.789Z" itemprop="datePublished">2025-03-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/15/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start">Quick Start</h2>
<h3 id="Create-a-new-post">Create a new post</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server">Run server</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files">Generate static files</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites">Deploy to remote sites</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://bob7452.github.io/2025/03/15/hello-world/" data-id="cmdbbev1j0005o3j651jbacxi" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Driver/" rel="tag">Linux - Driver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Understanding-Series/" rel="tag">Linux - Understanding Series</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/Linux-Driver/" style="font-size: 10px;">Linux - Driver</a> <a href="/tags/Linux-Understanding-Series/" style="font-size: 15px;">Linux - Understanding Series</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">ÂÖ´Êúà 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">‰∏ÉÊúà 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">‰∏âÊúà 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/08/03/%5B3%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [3]</a>
          </li>
        
          <li>
            <a href="/2025/08/03/%5B2%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [2]</a>
          </li>
        
          <li>
            <a href="/2025/08/02/%5B1%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [1]</a>
          </li>
        
          <li>
            <a href="/2025/07/19/%5B0%5D%20%20Simple-Rootfs-Implement/">Simple Rootfs [0]</a>
          </li>
        
          <li>
            <a href="/2025/03/22/Understanding-in-the-Linux-Kernel/">Understanding  in the Linux Kernel</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Tao<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>